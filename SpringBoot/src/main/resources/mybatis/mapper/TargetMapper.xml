<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.kbstar.mileEasy.mapper.TargetDao">
    <!-- 개인형 목표 추가하기-->
    <insert id="insertTarget" useGeneratedKeys="true" keyProperty="target_no">
        INSERT INTO target (mile_no, user_no, start_date, end_date, target_mileage, is_together, is_manager_plan)
        VALUES (#{mile_no}, #{user_no}, #{start_date}, #{end_date}, #{target_mileage}, #{is_together}, #{is_manager_plan})
    </insert>

    <insert id="insertUserTarget">
        INSERT INTO user_target (user_no, target_no, mile_no, start_date, end_date, target_mileage, is_together)
        VALUES (#{user_no}, #{target_no}, #{mile_no}, #{start_date}, #{end_date}, #{target_mileage}, #{is_together})
    </insert>

    <!-- 개인형 목표 불러오기-->
    <select id="getTargetsByUserNo" parameterType="string" resultType="com.kbstar.mileEasy.dto.Target">
        SELECT t.target_no, t.mile_no, t.user_no, t.start_date, t.end_date,
               t.target_mileage, t.is_together, t.is_manager_plan,
               m.mile_name,
               COALESCE(SUM(ms.mile_score_point), 0) AS achievementRate
        FROM target t
                 LEFT JOIN mile_score ms ON t.user_no = ms.user_no AND t.mile_no = ms.mile_no
                 LEFT JOIN mileage m ON t.mile_no = m.mile_no
        WHERE t.user_no = #{user_no}
        GROUP BY t.target_no, t.mile_no, t.user_no, t.start_date, t.end_date,
                 t.target_mileage, t.is_together, t.is_manager_plan, m.mile_name
    </select>

    <!-- 참여형 목표 불러오기 -->
    <select id="getAdminTargets" parameterType="string" resultType="com.kbstar.mileEasy.dto.Target">
        SELECT
            t.target_no,
            t.mile_no,
            t.user_no,
            t.start_date,
            t.end_date,
            t.target_mileage,
            t.is_together,
            t.is_manager_plan,
            m.mile_name,
            (SELECT COUNT(ut.user_no)
             FROM user_target ut
             WHERE ut.target_no = t.target_no
            ) AS participantCount,
            CASE
                WHEN t.target_mileage > 0 THEN
                    ROUND((COALESCE(SUM(ms.mile_score_point), 0) / t.target_mileage) * 100, 2)
                ELSE 0
                END AS achievementRate,
            -- 추가된 부분: 로그인한 사용자의 mile_score_point의 합계를 mile_no별로 계산
            (SELECT COALESCE(SUM(ms_inner.mile_score_point), 0)
             FROM mile_score ms_inner
             WHERE ms_inner.mile_no = t.mile_no
               AND ms_inner.user_no = #{userNo}  -- 로그인한 사용자의 user_no 기준으로 필터링
            ) AS totalMileScoreByMileNo
        FROM
            target t
                LEFT JOIN mile_score ms ON t.user_no = ms.user_no AND t.mile_no = ms.mile_no
                LEFT JOIN mileage m ON t.mile_no = m.mile_no
        WHERE
            t.is_manager_plan = true
        GROUP BY
            t.target_no,
            t.mile_no,
            t.user_no,
            t.start_date,
            t.end_date,
            t.target_mileage,
            t.is_together,
            t.is_manager_plan,
            m.mile_name;
    </select>

</mapper>
